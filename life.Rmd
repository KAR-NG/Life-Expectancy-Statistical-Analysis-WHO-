---
title: "Life Expectancy Statistical Analysis (WHO)"
author: "Kar Ng"
date: '2022-07'
output: 
  github_document: 
    toc: yes
    toc_depth: 4
    df_print: paged
  html_document:
    toc: yes
    toc_depth: '4'
    number_section: true
    df_print: paged
always_allow_html: yes
  
---

***

![](https://raw.githubusercontent.com/KAR-NG/life/main/pic2_thumbnails.png)

***

# ABSTRACT

This project analyses the factors related to life expectancy based on a public dataset from WHO. The data was collected between 2000 and 2015. Studied factors include development status of a country, GDP, population, schooling years, alcohol consumption, BMI, government expenditure on health, per-capital expenditure on health, various immunisation coverage, thinness disease, measles cases, HIV/AIDS deaths, and mortality rate of adult, children, and infants.

During data processing, data were thoroughly checked (horizontally and vertically), cleaned, and transformed. Missing values were imputed using Bagged-trees algorithm. During exploratory data analysis (EDA), box and whisker plot, histogram, and multiple factor analysis (MFA) were applied to explore and mine the overall trends within the data. MFA is an unsupervised machine learning technique. 8 questions were designed and answered statistically in this project. Depending on the nature of each question, multiple analysis techniques were applied such as multiple linear regression, correlation matrix, VIF, assumption diagnostic plots, Welchâ€™s t-test, principal component analysis (PCA), Shapiro-wilk test, Wilcoxon signed-rank test, and longitudinal multilevel mixed-effect modelling. 

Multiple linear regression model that passed the assumption tests shown that the positively correlated significant variables (p < 0.05) in relation to life expectancy are schooling (Coeff. Est: 1.15), total expenditure by government on health (Coeff. Est: 0.08), BMI (0.03), GDP (Coeff. Est: 0.00004), and the immunisation of Diphtheria (Coeff. Est: 0.03) and Polio (Coeff. Est: 0.02), whereas, the negatively correlated significant variables (p < 0.05) are developing country status (Coeff. Est: -1.12), HIV/AIDS Death rate (Coeff. Est: -0.51), Adult mortality rate (Coeff. Est: -0.02), and infant deaths (Coeff. Est: -0.002) (adjusted R-squared: 0.85, F(15, 2775) = 1087, p < 0.001). A partial analysis from the full model of longitudinal multilevel modeling supports similar outcomes and it detected that if a country has lower initial life expectancy in year-2000, it would have a higher rate in life expectancy improvement across the year between 2000 and 2015 (intercept-slope corr = -0.55). It implies improvement of life expectancy in developing countries that associated with lower life expectancy since 2000 to 2015. The full model also concludes that life expectancy of human increases each year by 0.25 year on average, with a confidence level between 0.16 year and 0.34 year (p < 0.001). 

**Highlights**

![](https://raw.githubusercontent.com/KAR-NG/life/main/pic1_graphs.png)





# R PACKAGES

Following R packages are loaded for this project.

```{r, message=FALSE, warning=FALSE}
# Environment setting (to remove scientific notation)

options(scipen = 999)  

# Packages loaded

library(tidyverse)
library(kableExtra)
library(skimr)
library(caret)
library(tableone)
library(factoextra)
library(FactoMineR)
library(car)
library(mvnormtest)
library(biotools)
library(corrplot)
library(cowplot)
library(hrbrthemes)
library(broom)
library(ggpubr)
library(rstatix)
library(nlme)
library(performance)

```

# DATA PREPARATION

Dataset used in this project is publicly available on *Kaggle* website. *Kaggle* is a well-known platform for data analysts and data scientists for sharing data, codes, resources, and ideas. The dataset is accessible via this [Link](https://www.kaggle.com/datasets/kumarajarshi/life-expectancy-who). 

## Data Import

Following are 10 randomly selected observations (rows) from the dataset:

```{r}
life <- read.csv("Life Expectancy Data.csv")
  
sample_n(life, 10)

```

## Data Description

```{r}

No. <- c(1:22)

Variable <- c("Country", 
              "Year",
              "Status",
              "Life expectancy",
              "Adult Mortality",
              "infant deaths",
              "Alcohol",
              "percentage expenditure",
              "Hepatitis B",
              "Measles",
              "BMI",
              "under-five deaths",
              "Polio",
              "Total expenditure",
              "Diphtheria",
              "HIV/AIDS",
              "GDP",
              "Population",
              "thinness 10-19 years",
              "thinness 5-9 years",
              "Income composition of resources",
              "Schooling")

Description <- c("Country", 
                 "Year",
                 "Developed or Developing status",
                 "Life Expectancy in age",
                 "Adult Mortality Rates of both sexes (probability of dying between 15 and 60 years per 1000 population)",
                 "Number of Infant Deaths per 1000 population",
                 "Alcohol, recorded per capita (15+) consumption (in litres of pure alcohol)",
                 "Expenditure on health as a percentage of Gross Domestic Product per capita(%)",
                 "Hepatitis B (HepB) immunization coverage among 1-year-olds (%)",
                 "Measles - number of reported cases per 1000 population",
                 "Average Body Mass Index of entire population",
                 "Number of under-five deaths per 1000 population",
                 "Polio (Pol3) immunization coverage among 1-year-olds (%)",
                 "General government expenditure on health as a percentage of total government expenditure (%)",
                 "Diphtheria tetanus toxoid and pertussis (DTP3) immunization coverage among 1-year-olds (%)",
                 "Deaths per 1 000 live births HIV/AIDS (0-4 years)",
                 "Gross Domestic Product per capita (in USD)",
                 "Population of the country",
                 "Prevalence of thinness among children and adolescents for Age 10 to 19 (%)",
                 "Prevalence of thinness among children for Age 5 to 9(%)",
                 "Human Development Index in terms of income composition of resources (index ranging from 0 to 1)",
                 "Number of years of Schooling(years)"
                 )

data.frame(No., Variable, Description) %>% 
  kbl() %>% 
  kable_styling(bootstrap_options = c("bordered", "stripped", "hover"), 
                full_width = T)

```


## Data Exploration

### Data type and structure

There are 2938 rows of observations and 22 columns of variables. 

```{r}
glimpse(life)

```

### Vertical NA Check (Column)

There are 2 character variables "Country" and "Status", and the rest of the variables are numerical. 

```{r}
skim_without_charts(life)

```

From the variables "n_missing" and "complete_rate", they detected a lot of missing data in many variables. Mean and standard deviation are also being computed.

A good thing is that there is no variable having more than 40% missing data because I will follow a 60% rule that if a column (variable) has less than 0.6 completion rate (having 0.4 or 40% missing data), I will consider dropping the variable.

The number of missing data in each column can also be examined using following code:

```{r}
colSums(is.na(life))

```

### Horizontal NA Check (Row)

Here performs horizontal missing value check. 

```{r}
life %>% 
  mutate(row.id = c(1:nrow(life))) %>% 
  relocate(row.id, .before = Country) %>% 
  gather(key = "variables", value = "values", -row.id) %>% 
  filter(is.na(values)) %>% 
  group_by(row.id) %>% 
  summarise(count = n()) %>% 
  arrange(-count) %>% 
  mutate(total.column = 22,
         propor.NA.per.row = paste0(round(count/total.column*100,1), "%")) 


```

If a row (observation) contains too many missing values, it should be removed otherwise filling up its missing values by estimation would be too unrealistic and synthetic. Generally, one should remove a row if it contains 60% of missing values. One can also choose not to remove a row with many missing values if some of its data is useful to analyse a particular important business question.  

From the table above, there are 1289 rows out of the 2938 rows contain missing value. It will be less practical to remove all of these rows just to be able to ensure there is no missing data in the dataset. Furthermore, the maximum proportion of missing value is 40.9% which is less than 60%.   

In this project, I will adopt an imputation method using machine learning algorithm to fill up these missing values. The algorithm will make use of the entire dataset and predict what might the best possible estimates for these missing cells. 


# DATA CLEANING

## White Space Trimming and punctuation remove

Remove leading and/or trailing white spaces in character variables "Country" and "Status".

```{r}
life <- life %>% 
  mutate(Country = str_replace_all(Country, "[[:punct:]]", " "),
         Country = trimws(Country),
         Status = trimws(Status))

```


## Rename Levels

Replacing spaces in some of the country names by underscore. For example "Antigua and Barbuda" to "Antigua_and_Barbuda". This is to avoid complication during imputation using the machine learning technique. 

```{r}
life <- life %>% 
  mutate(Country = str_replace_all(Country, " ", "_"))

```

## Factor conversion

This section converts "Country", "Year", and "Status" into factor because of their categorical nature. 

```{r}
life <- life %>% 
  mutate(Country = as.factor(Country),
         Year = as.factor(Year),
         Status = as.factor(Status))

```

From this point onward, the dataset object name will be changed from "life" to "life2", so to have "life" object as a backup before further transformations.

```{r}
life2 <- life

```


## Bag imputation

This section applies imputation model to fill up missing values in the dataset. There are many types of imputation methods including using mean, median, and mode (most occurring values, generally applied to categorical data). One of the methods is applying machine learning algorithms for imputation. They will make use of the entire dataset to predict possible estimates for these missing values. It is generally considered a better estimation technique if missing values are not too much. This machine learning imputation technique I am applying will take into account all information in the dataset when filling up missing values. 

However, one should note that it is still an estimation technique and is not 100% accurate representation of the truth, checking and transformation might be required, depends on the nature of the variable. It is disputable that whether this technique is the best technique, it depends on a case-by-case basis and the goals of each analysis. Since the goal of this project is to demonstrate my skills instead of doing real, detail analysis for WHO, I will use the machine learning technique to fill up these missing value.

Following codes complete the imputation of missing values using bagged-tree algorithm.

*One hot encoding (Making dummies):*

```{r}

# dummy_function <- dummyVars(~., data = life2)
# life_dummy <- dummy_function %>% predict(life2)
```

*Impute using bagged tree models*

```{R}

# bagimpute <- life_dummy %>% preProcess(method = "bagImpute")
# life_dummy_imputed <- bagimpute %>% predict(life_dummy)
# life_dummy_df <- as.tibble(life_dummy_imputed)

```

Replace the columns that has missing values in the original dataset "life2". 

```{r}
# Extract imputed columns into life2

# life2$Life.expectancy <- life_dummy_df$Life.expectancy
# life2$Adult.Mortality <- life_dummy_df$Adult.Mortality
# life2$Alcohol <- life_dummy_df$Alcohol
# life2$Hepatitis.B <- life_dummy_df$Hepatitis.B
# life2$BMI <- life_dummy_df$BMI
# life2$Polio <- life_dummy_df$Polio
# life2$Total.expenditure <- life_dummy_df$Total.expenditure
# life2$Diphtheria <- life_dummy_df$Diphtheria
# life2$GDP <- life_dummy_df$GDP
# life2$Population <- life_dummy_df$Population
# life2$thinness..1.19.years <- life_dummy_df$thinness..1.19.years
# life2$thinness.5.9.years <- life_dummy_df$thinness.5.9.years
# life2$Income.composition.of.resources <- life_dummy_df$Income.composition.of.resources
# life2$Schooling <- life_dummy_df$Schooling
  
```

The above imputation has actually been completed and the new imputed dataset has been saved to my computer. Following section imports the imputed dataset back to R with some manipulation to make sure it is perfect prior to analysis. 

```{r}
# write.csv(life2, "life2.csv")

life.data <- read.csv("life2.csv", header = T, stringsAsFactors = T)

life.data <- life.data %>% 
  dplyr::select(-X) %>% 
  mutate(Year = as.factor(Year)) %>% 
  rename("thinness.btw.10.19years" = "thinness..1.19.years",
         "thinness.btw.5.9years" = "thinness.5.9.years"
         )

```

 Checking the data structure.

```{r}
str(life.data)

```

Checking the missing data.

```{r}
colSums(is.na(life.data))
```


# EDA 

## Histogram for Distribution

Most of the variables have skewed distribution, except that life expectancy, schooling, total expenditure, and income composition of resources have a distribution near normal. BMI has a clear bimodal distribution.

```{r, fig.width=14, fig.height=10, message=FALSE, warning=FALSE}
# set up df

life.data.num <- life.data %>% select_if(is.numeric)

# plot

life.data.num %>% 
  gather(key = key, value = value) %>% 
  mutate(key = as.factor(key)) %>% 
  ggplot(aes(x = value, fill = key)) +
  geom_histogram(colour = "black") +
  facet_wrap(~key, scales = "free", ncol = 5) +
  theme_classic() +
  theme(legend.position = "none",
        strip.background = element_rect(fill = "grey"),
        strip.text = element_text(colour = "black", face = "bold", size = 8)) +
  labs(x = "Values", y = "Count")


```

## Boxplot for Outliers

From following boxplot, almost all numerical independent variables have outliers except BMI.

```{r, fig.width=14, fig.height=10, message=FALSE, warning=FALSE}

life.data.num %>% 
  gather(key = key, value = value) %>% 
  mutate(key = as.factor(key)) %>% 
  ggplot(aes(x = value, fill = key)) +
  geom_boxplot(colour = "black") +
  facet_wrap(~key, scales = "free") +
  theme_classic() +
  theme(legend.position = "none",
        strip.background = element_rect(fill = "grey"),
        strip.text = element_text(colour = "black", face = "bold", size = 9),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

```
Checking out the proportion of outliers in each variable (%): 

```{r, fig.width=9, fig.height=9}

variable.name <- colnames(life.data.num)

outlier.percentage <- c(
(length(boxplot.stats(life.data.num$Life.expectancy)$out)/2938)*100,
(length(boxplot.stats(life.data.num$Adult.Mortality)$out)/2938)*100,
(length(boxplot.stats(life.data.num$infant.deaths)$out)/2938)*100,
(length(boxplot.stats(life.data.num$Alcohol)$out)/2938)*100,
(length(boxplot.stats(life.data.num$percentage.expenditure)$out)/2938)*100,
(length(boxplot.stats(life.data.num$Hepatitis.B)$out)/2938)*100,
(length(boxplot.stats(life.data.num$Measles)$out)/2938)*100,
(length(boxplot.stats(life.data.num$BMI)$out)/2938)*100,
(length(boxplot.stats(life.data.num$under.five.deaths)$out)/2938)*100,
(length(boxplot.stats(life.data.num$Polio)$out)/2938)*100,
(length(boxplot.stats(life.data.num$Total.expenditure)$out)/2938)*100,
(length(boxplot.stats(life.data.num$Diphtheria)$out)/2938)*100,
(length(boxplot.stats(life.data.num$HIV.AIDS)$out)/2938)*100,
(length(boxplot.stats(life.data.num$GDP)$out)/2938)*100,
(length(boxplot.stats(life.data.num$Population)$out)/2938)*100,
(length(boxplot.stats(life.data.num$thinness..1.19.years)$out)/2938)*100,
(length(boxplot.stats(life.data.num$thinness.5.9.years)$out)/2938)*100,
(length(boxplot.stats(life.data.num$Income.composition.of.resources)$out)/2938)*100,
(length(boxplot.stats(life.data.num$Schooling)$out)/2938)*100
)

data.frame(variable.name, outlier.percentage) %>% 
  mutate(variable.name = as.factor(variable.name),
         outlier.percentage = round(outlier.percentage, 2)) %>% 
  ggplot(aes(y = fct_reorder(variable.name, outlier.percentage), x = outlier.percentage)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  theme(plot.title = element_text(face = "bold")) +
  labs(x = "Outlier Count (%)",
       y = "Variables",
       title = "Proportion of Outliers in Each Variable (By IQR Method)") +
  geom_label(aes(label = paste0(outlier.percentage, "%"))) +
  scale_x_continuous(limits = c(0, 20))

```


There are different types of outliers and are broadly categorised into (1) *false outliers* that caused by data input error or typo (which I assume would not happen to this dataset) and (2) *true outliers* that the outlier data points are naturally just too different from other data points. 

There are many ways to deal with outliers, one can simply rectify it if it is caused by human error, however if it is not, there are two main methods to use: 

(1) *Trimming*, remove the entire row in a table if the row contains an outlier and this may cause a substantial reduction of sample size, 

(2) *Winsorisation*, capping the outliers by changing them to pre-specified maximum and minimum quantile values, such as the 95% quantile and the 5% quantile. 

However, trimming and winsorisation are only feasible if we have less than 5% outliers otherwise the hypothesis testing outcome would be affected statistically and may not revealing desirable trends. 

I will not manage the outliers now, instead I will use other outlier definitions (leverage, influential value, and cooks distance values) when building a multiple linear regression model in later section. Outliers will be defined based on their impact on the regression model. 


## MFA

Multiple Factor Analysis (MFA) is used in this section to find the relationships among all variables at once. It is a type of unsupervised machine learning technique. It reduces the dimensions of the datasets into a few principal components for trend mining purposes. 

One of the "special feature" of MFA is that all variables (both categorical and numerical) can be grouped into sub-group based on their nature and having their trends and inter-relationships monitored all at once.  

The variables in the dataset can be grouped into following 6 subcategories.  

***

**status**: Country, Year, Status      

**longevity**: Life.expectancy, Adult.Mortality, infant.deaths, under.five.deaths  

**health**: Alcohol, BMI  

**healthcare**: percentage.expenditure, Hepatitis.B, Polio, Total.expenditure, Diphtheria  

**disease**: Measles, HIV.AIDS, thinness..1.19.years, thinness.5.9.years  

**economic**: GDP, Population, Schooling, Income.composition.of.resources  

***

The "status" group will be identified as *supplementary group* in the analysis which means that the variables in the "status" group will not be participating in the MFA computation but will be used to understand the output as supplementary information. All other groups will be treated as *active group* and they will take part in MFA computation. 

```{r}
# Data set rearrangement

life.data.mfa <- life.data %>% 
  dplyr::select(Country, Year, Status, Life.expectancy, Adult.Mortality, infant.deaths, under.five.deaths, Alcohol, BMI, percentage.expenditure, Hepatitis.B, Polio, Total.expenditure, Diphtheria, Measles, HIV.AIDS, thinness.btw.10.19years, thinness.btw.5.9years, GDP, Population, Schooling, Income.composition.of.resources)

# mfa 

res.mfa <- MFA(life.data.mfa,
               group = c(3, 4, 2, 5, 4, 4),
               type = c("n", "s", "s", "s", "s", "s"),
               name.group = c("status", "longevity", "health", "healthcare", "disease", "economic"),
               num.group.sup = 1,
               graph = F)  


```


Total variation in the dataset has been extracted and are expressed in 10 principal components (Dimensions). The first two dimensions explain the most variation (34.6% and 13.5%), and the amount of variation explains in subsequent dimensions hit a drastic reduction after the second dimension, based on the "Knee Method" of scree plot, I will use the first two dimensions for factor map. 

```{r}
fviz_screeplot(res.mfa, addlabels = T, ylim = c(0, 40))

```

In following plot, supplementary group "status" is colored with green and red for the active groups. 

```{r, fig.height=12, fig.width=12}
f1 <- fviz_mfa_var(res.mfa, choice = "group", repel = T)
f2 <- fviz_contrib(res.mfa, choice = "group", axes = 1)
f3 <- fviz_contrib(res.mfa, choice = "group", axes = 2)
f4 <- fviz_contrib(res.mfa, choice = "group", axes = 1:2)
  
f234 <- plot_grid(f2, f3, f4, ncol = 3)

plot_grid(f1, f234, ncol = 1)  
  
```

**Insights**: 

* In dimension 1 (34.6%) on the top factor map, variables in all active groups except "healthcare" have almost identical coordinates, which means they contribute similarly to the first dimension. Healthcare group contribution is slightly lesser than the rest. 

* In dimension 2 (13.5%) on the top factor map, the variables in the group "longevity" contribute the most to the second dimension, followed by the variables in the "economic" group.

* In three of the following plots, the red line is "expected average value", group that higher than this line are important groups in explaining the variability in the dataset. Variables important to Dim-1 belong to economic, longevity and health group. Variables important to Dim-2 belong to "longevity" and "economic". 

* Variables from both "longevity" and "economic" groups are most important to both axes.


Now, let's look at the most exciting Factor map of MFA:

```{r, fig.width=10, fig.height=10, warning=FALSE, message=FALSE}

fviz_mfa_var(res.mfa,
             choice = "quanti.var",  
             palette = "jco",  
             repel = T, 
             habillage = "Status")    

```

**Guides**:

1. Positively related variables are grouped together.

2. Negatively related variables are positioned on opposite sides of the plot origin.  

3. Arrows of each variable indicate the quality of the variable on the factor map, variables with long arrows are well represented on the factor map (more important to look). The metric that related to the representation of variables is technically known as "Cosine-squared".  

**Insights**:

* The variables associated with the "*economic*" group and "*healthcare*" group are positively associated with each other, except the variable "population". It indicates the better the economic of a country, the better healthcare system a country can establish. Therefore, people in countries with better economic and healthcare have longer lifespan, as indicated by the positively related "Life expectancy" variable.  

* High "Body mass index - BMI" and "Alcohol consumption" would be the main issues of health when economic increases.  

* The "*economic*" group and "*healthcare*" group are less associated and negatively associated with variables in the "**disease**" group. When economics and healthcare variables have reduction in values, the variables in the *disease* group increase their magnitudes. 

* HIV/AIDS is most likely the reason causing adult mortality.  

* Measles is strongly associated with "death under 5 years old" and "infant deaths". Measles is a typical infectious viral disease that causing fever and skin red rash in early childhood. Both the variables "death under 5 years old" and "infant deaths" have a near-perfect positive correlation.

* "Thinness in 5 to 9 years old" and "Thinness in 10 to 19 years old" are also having a near-perfect positive correlation.

Following shows the "MFA-Individual" map. This plot shows all the data points from the dataset onto the same factor map as above, with overlapping of supplementary categorical variables, which are "Country", "Year", and "Development Status". Three bar plots located at the bottom are guides to see what variables contribute the most to each dimension (Dimension 1, Dimension 2, or both Dimension 1-2). Variables that contribute the most are the most important variables in explaining the variability in the data. 

```{r, fig.width=18, fig.height=14, warning=FALSE, message=FALSE}

f1 <- fviz_mfa_ind(res.mfa, 
             repel = T,
             palette = "jco",
             habillage = "Status",
             addEllipses = T,
             ellipse.type = "convex")

f2 <- fviz_contrib(res.mfa, choice = "quanti.var", axes = 1) + theme(legend.position = "top")
f3 <- fviz_contrib(res.mfa, choice = "quanti.var", axes = 2) + theme(legend.position = "top")

bottom <- plot_grid(f2, f3, ncol = 2)

plot_grid(f1, bottom,
          ncol = 1)

```
**Insights**:

* There is a cluster for developing countries with their data points, and a cluster for developed countries with their data points. The separation is moderately good with some overlapping.  

* Data points (or called "Individual" technically in PC methods) with similar profile are grouped together.

* Dimension 1 is contributed the most by BMI, Life expectancy, schooling, Income composition of resources, Alcohol consumption, thinness between 5 to 9 years old, and thinness between 10 to 19 years old. The red horizontal line in the bottom plots is a line of average contribution by all variables, variables that having a contribution higher than the red line is considered important for interpretation.  

* Dimension 2 is contributed to most by Infant deaths, under-5 death, population, and measles. India is the most associated country to these attributes. 

* Developing countries have higher positive association with "thinness between 10 to 19 years old" and "thinness between 5 to 9 years old". They have negative relationship or lower association with BMI, Life expectancy, schooling, Income composition of resources, and Alcohol consumption. Whereas, developed countries are the opposite of these characterization. 

Now we roughly know where are the data points (individuals) of developing and developed countries located. 

Following shows the partial points of each data points. 

```{r, fig.width=14, fig.height=10}
fviz_mfa_ind(res.mfa, 
             partial = "all",
             palette = "jco"
             ) +
  
  labs(title = "Partial Individuals Analysis",
       subtitle = "Individual - MFA")

```


Since there are so many data points crowded together, We can only draw some general trends. 

*  On **disease** group point of view, developing countries (many are located at the left side of the vertical line in the graph) has high value for **disease** group ("Measles", "HIV.AIDS", "thinness..1.19.years", and "thinness.5.9.years"). 

* "Thinness..1.19.years" and "thinness.5.9.years" contributed the most to dimension 1 and many developing countries have high value in these disease variables. This partial analysis is not very effective at capturing trends clearly in this dataset because of large sample size, let's move on to the next section. 

# SUMMARY STATISTICS

## Categorical variables

Key points:

* There are 193 countries contributed to this survey.     

* Data in this dataset are recorded between 2000 and 2015.   

* All data are recorded for developed and developing countries.   

```{r}
length(unique(life.data$Country))
unique(life.data$Year)
unique(life.data$Status)

```


## Sample size assessment

Sample size needs to be big enough or statistically enough to represent the profile of a particular population. There are many theories about what is the best sample size:

* In an environmental-controlled experiment, the absolute minimum is suggested to be 6

* When a sample size reach 23 to 25, the t-distribution will become quite close to z-distribution (population distribution)

* Therefore, in a rule of thumb, a minimum of 30 is commonly suggested the best sample size 

The best sample size depends on situation and application really. The more is better but depends on the costs allowed. There is math to help achieving a desired sample size (using means plus/minus the margin of error), but this usually suggests a large sample size and the feasibility depends on approved resources. In short, the bigger the sample size, we will hope it would start represent the population statistics, with smaller margin of error, and the confidence interval at a confidence level of interest (95% generally). 

1) Following are the sample sizes for the "developed" and "developing" category. These sample sizes are suggesting a feasibility of using statistical test to find significant difference between the two groups.

```{r}

table(life.data$Status)

```

2) Following are the sample sizes for the Years category. They are quite similar to each other. These sample sizes are suggesting a feasibility of using statistical tests to find significant difference between the year groups.

```{r, fig.width=12}
life.data %>% dplyr::select( Year) %>% group_by(Year) %>% summarise(count = n()) %>% 
  ggplot(aes(x = Year, y = count)) +
  geom_bar(stat= "identity") +
  geom_text(aes(label = paste0("(", count, ")"), vjust = -1)) +
  theme_classic() +
    scale_y_continuous(limits = c(0, 220)) +
  labs(title = "There are 183 data recorded for each Year (193 for 2013)")

```

3) The sample size of each country might be too small for statistical comparison. 

There are 10 countries with only 1 sample collected and all remaining 183 countries have only 16 samples collected. There would be a lot of sampling bias if the factor variable "Country" is involved in statistical comparison, the data might be too small to represent each country.

```{r}
life.data %>% dplyr::select(Country) %>% 
  group_by(Country) %>% 
  summarise(sample.size = n()) %>% 
  arrange(sample.size) %>% 
  mutate(sample.size = as.factor(sample.size)) %>% 
  group_by(sample.size) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(x = "", y = count, fill = sample.size)) +
  geom_histogram(stat = "identity") +
  coord_polar(theta = "y", start = 0) +
  geom_text(aes(label = paste0("Countries with Sample Size ", sample.size, ": \n", count)),
            position = position_stack(vjust = 0.5)) +
  theme_minimal() +
  theme(axis.title = element_blank(),
        legend.position = "none",
        strip.text = element_text(size = 15), 
        plot.title = element_text(hjust = 0.5, face = "bold", vjust = 2),
        plot.subtitle = element_text(hjust = 0.5, vjust = 2)) 

```

## Central tendency statistics

Following show the summary statistics of developed and developing countries. The "skew" stands for skewness of data distribution, a 0 value of skew means normal distribution. The "kurt" stands for "Kurtosis", it is a metric measures the spread of the data, a positive value indicates a less spread of the data (better), a negative value indicates more spread of the data (flat-shape distribution). 

```{r}
life.df <- life.data %>% 
  dplyr::select(- Country)

mytable <- CreateTableOne(data = life.df, strata = "Status", test = F)
summary(mytable) 

```

A box plot will help visually compares the central tendency statistics of developed and developing countries. Following shows the box plots of each numerical variables in the dataset, categorized by country status, and overlapped with respective data points.   

Note:

* The central line of box plot is the **median**, and should be used when the distribution is skewed by outliers.    
* I added the "cross shape" point in each box plot to indicate where the **mean** is.    
* Data points that located outside of the boxplot tails (top and bottom) are known as **outliers**.     

```{r, fig.width=12, fig.height=12}

life.data %>% 
  dplyr::select(-Country, -Year) %>% 
  pivot_longer(c(2:20), names_to = "my.var", values_to = "my.val") %>% 
  mutate(my.var = as.factor(my.var)) %>% 
  ggplot(aes(x = Status, y = my.val, color = Status)) +
  geom_jitter(alpha = 0.1) +
  geom_boxplot(outlier.shape = NA, color = "black", alpha = 0) +
  stat_summary(fun = mean, geom = "point", color = "black", shape = 4, size = 5) +
  facet_wrap(~my.var, scales = "free") +
  stat_boxplot(geom = "errorbar", width = 0.2, color = "black") +
  theme_bw() +
  theme(legend.position = "top",
        plot.title = element_text(face = "bold", hjust = 0.5)) +
  labs(x = "Country Status",
       y = "Values",
       title = "Box Plot")


```

*Insights*

I will use the 5 grouping themes in MFA to help interpretation. Following are general trends detected from the box plot: 

* Regarding **longevity**, developed countries has higher life expectancy, lower adult mortality, infant deaths, and deaths among children under 5 years old.

* Regarding **health**, alcohol consumption and BMI are the main concerns of most developed countries. However, both of the issues also happen in many developing countries. 

* Regarding **healthcare**, based on median point, developed countries have higher "percentage.expenditure", which is the expenditure on health as a percentage of Gross Domestic Product per capita(%), and higher "Total expenditure", which is the general government expenditure on health as a percentage of total government expenditure (%). Both developing countries and developed countries have similar immunisation coverage of "Hepatitis.B", "Polio", and "Diphtheria". However, there are many data points showing some developing countries need improvement in immunisation of these diseases.

* Regarding **disease**, Measles cases, HIV/AIDS deaths, thinness between 5 and 9 years old, and thinness between 10 and 19 years old are more severe in developing countries.

* Regarding **economic**, GDP is generally substantially higher in developed countries, whereas population is generally higher in developing countries. People in developed countries have higher years of schooling. Developed countries also have higher "Income.composition.of.resources" which is the Human Development Index in terms of income composition of resources. 


# STATISTICAL ANALYSIS 

In following sections, a series of business questions have been designed and will be answered using statistical techniques.  

## Q1. Factors that Affecting Life Expectancy

**What are the predicting variables actually affecting the life expectancy?**

In this question, *life expectancy* will be the dependent variables and the other variables are independent variables.

### Multicollinearity Test 

First, I will examine multicollinearity problems among numerical independent variables. Multicollinearity is an extreme problem when there is high correlation among two or more independent numerical variables. The consequences are that (1) standard errors in the regression model would be inflated, and affects the accuracy of the beta coefficient estimates, (2) lower down the t statistics, and (3) therefore increase the P-value. It is usually understood as redundancy of variables in the dataset when two variables are highly correlated. 

Two thresholds I will be using to detect multicollinearity issue:

* Correlation > 0.7 (Anderson, Sweeney & Williams 2006)    
* VIF > 5 (James et al. 2014)    

When correlation is higher than 7 or VIF (Variance inflation factor) > 5, then there would be a serious multicollinearity problem. Although there are these maximum thresholds for us to refer to but the general aim is to try to keep these thresholds as low as possible.  

From the correlation graph below, highly correlated independent variables (both negatively and positively) are identified:

* **Under.five.deaths** and **infant.deaths**, at a perfect correlation of 1. **Under.five.deaths** will be selected when building multiple linear regression model because it has slightly better correlation with life expectancy.

* **GDP** and **percentage expenditure** have a correlation of 0.9. **GDP** will be selected with the same reason as Under.five.death.  

* Both **thinness** variables are highly correlated (0.94) and both are correlated to life expectancy at the same degree. I will keep **thinness prevalence between 5 to 9 years old** as it might be more important to look at because children are more vulnerable compared to 10 to 19 years old teenagers.   

* **Schooling** and **income.composition.of.resource** are highly correlated, I will choose schooling for the same reason as the variable  **Under.five.death**. 

```{r, fig.width=12, fig.height=12}

# correlation computation
num.var <- life.data %>% select_if(is.numeric)
num.var_cor <- cor(num.var)

# plot
corrplot(num.var_cor, method = "number", type = "upper")

```

Therefore, I will build my multiple linear regression model without following numerical variables:

```{r}
Removed_Variables <- c("under.five.deaths", "thinness.btw.10.19years", "percentage.expenditure", "Income.composition.of.resources")
Removed_Variables <- data.frame(Removed_Variables)
Removed_Variables %>% kbl() %>% kable_styling(bootstrap_options = c("bordered", "striped", "hover"), full_width = F)

```

### MLR Model

Building the model:

```{r}
res.mlr <- lm(Life.expectancy ~ .- Country - Year - under.five.deaths - thinness.btw.10.19years - percentage.expenditure - Income.composition.of.resources, data = life.data)

```

Before interpreting the model, I will run a series of diagnostic plots to make sure the reliability of the statistical outcomes in the model. 

### VIF check

Applying variance inflation factor (VIF) to check multicollinearity.

```{r}
vifout <- car::vif(res.mlr)
vifout %>% kbl(col.names = "VIF") %>% 
  kable_styling(bootstrap_options = c("stripped", "bordered", "hover"), full_width = F)


```

VIF of all variables are closed to 1 and 2, which is excellent, and the multicollinearity problem can be said has been removed from the model with the aid of correlation analysis. 

### Assumptions diagnostic

Assumptions of multiple linear regression have to be met otherwise the output statistics from the linear regression model would be inaccurate. This section will check out the various diagnostic plots for linear regression analysis and make transformation to the dataset if necessary. 

To meet the linear regression model assumptions, there are a series of "surgeries" we can do inclusively or exclusively, for examples, removal of outliers and influential points, features section (exclude or including variables), transforming the response or predictors, weighting the measurement to improve fit, or switching to a different type of model. 

```{r, fig.width=12, fig.height=8}

par(mfrow = c(2, 3))

plot(res.mlr, which = 1:5)  

```

* In "**Residuals vs Fitter**" graph, the data points of residuals follow roughly a straight line at approximate 0. Therefore, I assume that the relationship between the independent variables and life expectancy is linear. 

* The **Q-Q plot**, most of the data in the middle follows a straight line. It indicates that the residuals are roughly normally distributed. 

* In **Scale-Location**, there is a gradually decreasing variance indicating that it may be an indication of heteroscedasticity.

* In the **Residuals vs Leverage** plot, this plot help to find influential data point that an inclusion or exclusion of it can alter the results of the multiple linear regression because these data points are associated with large residuals. Visually from the plot, there are no data points located outside of the Cook's distance dash line located at the upper right and bottom right areas and which indicate no influential points. However, I would try to use mathematics method to find high influential values.
  
  * Apart from searching for influential values, outliers to the model can be detected but they may not influence the model output. An outlier here is a point that has an extreme outcome variable value. Observations with standardized residuals higher than 3 in absolute values are possible outliers (James et al. 2014), and there are *28* of them (see below and the ".std.resid" column). 
  
```{r}
model.diag.metrics <- augment(res.mlr) %>% dplyr::select(.fitted, .resid, .hat, .cooksd, .std.resid)
model.diag.metrics %>% filter(.std.resid <= -3 |
                              .std.resid >= 3)

```
  
  * Compared to outliers, I will instead look at cook distance metric to decide whether a data point should be removed. Applying a rule of thumb established by P. Bruce and Bruce 2017, an observation is considered having a high influence to the model if its Cook's distance is higher than 4/(n - p - 1), where n is the number of observations (2938 rows of data in our case) and p is the number of predictor variables (15 predictors in our case). 

$$

4/(n - p - 1) = 4/(2938 - 15 -1) = 0.001368925

$$
  * From following computation, there are 212 data points from the dataset (7.215%) are associated with large residuals and removal of them may help improve the model. 

```{r}

influential.obs <- model.diag.metrics %>% 
  mutate(row.id = 1:nrow(model.diag.metrics)) %>% 
  relocate(row.id, .before = .fitted) %>% 
  dplyr::select(row.id, .cooksd) %>% 
  filter(.cooksd >= 0.001368925)

nrow(influential.obs)

```

```{r}
212/2938 * 100

```

However, I will only remove 147 data points who has the largest Cooks distance (.cooksd) so that I will only remove a maximum of 5% of data from the dataset instead of 7.215% to avoid the chance of influencing the model output statistically.  

```{r}
5/100*2938
 
```

Creating an influential.obs table with 147 of the targeted data points.

```{r}
influential.obs2 <- model.diag.metrics %>% 
  mutate(row.id = 1:nrow(model.diag.metrics)) %>% 
  relocate(row.id, .before = .fitted) %>% 
  dplyr::select(row.id, .cooksd) %>% 
  filter(.cooksd >= 0.001368925) %>% 
  arrange(-.cooksd) %>% 
  slice_head(n = 147)

```


### MLR Model 2

Anti-join the life.data dataset from the influential.obs table and create a new table that has 2791 rows of data (147 large residual influential points have been removed).

```{r}
life.data.withoutInflenObs <- life.data %>% 
  mutate(row.id = 1:nrow(life.data)) %>% 
  relocate(row.id, .before = Country) %>% 
  anti_join(influential.obs2, by = "row.id") %>% 
  dplyr::select(-row.id)

```

Making the second multiple linear regression model:

```{r}
res.mlr2 <- lm(Life.expectancy ~ .- Country - Year - under.five.deaths - thinness.btw.10.19years - percentage.expenditure - Income.composition.of.resources, data = life.data.withoutInflenObs)

```

```{r, fig.width=12, fig.height=8}
par(mfrow = c(2, 3))
plot(res.mlr2, which = 1:5)

```

Now the linear relationship, normality, and homogeneity of variance have improved and met the assumptions of linear regression. The residual data points on "Scale-Location" plot has become more random and equally spread and the red line in the middle of the plot has become more horizontal. There are no high influential points outside of the cook's distance on the "Residuals vs Leverage" plot.

### Model Interpretation

The multiple linear regression show that:

* According to **Adjusted R-squared**, The model can explain 85.5% of variability of life expectancy, which is a very high level.  

* The F-statistic is 1032 and an overall P-value of less than 0.001, which indicates that at least 1 variable is statistically related to the life expectancy.  

* Variables that has a P-value ("Pr(>|t|)") less than 0.05 (as indicated with "*") are statistically affecting life expectancy. 

```{r}
summary(res.mlr2)

```
* Following are variables that statistically affecting the life expectancy in a **positive** way, with a P-value of less than 0.05. 

```{r}

output.table <- summary(res.mlr2)$coefficients %>% 
  data.frame() %>% 
  dplyr::select(Estimate, Pr...t..) %>% 
  rename("P.value" = Pr...t..) %>% 
  filter(P.value < 0.05) %>% 
  arrange(P.value) %>% 
  mutate(P.value = round(P.value, 6))
  
output.table[-1, ] %>% 
  filter(Estimate > 0) %>% 
  arrange(-Estimate) %>% 
  kbl() %>% 
  kable_styling(bootstrap_options = c("hover", "bordered"), full_width = F)

```


* Following are variables that statistically affecting the life expectancy in a **negative** way, with a P-value of less than 0.05. 

```{r}

output.table[-1, ] %>% 
  filter(Estimate < 0) %>% 
  arrange(Estimate) %>% 
  kbl() %>% 
  kable_styling(bootstrap_options = c("hover", "bordered"), full_width = F)

```



## Q2. Investigate the Effectiveness of Health Expenditure

**Question: Should a country having a lower life expectancy value(<65) increase its healthcare expenditure in order to improve its average lifespan?**

Yes for two reasons. 

*Reason 1*: Based on the multiple linear regression in previous section, it indicated that total expenditure by government on healthcare is statistically related to life expectancy in a positive way, at a significant P-value of lower than 0.01. It indicates that 1% increase in the healthcare expenditure by government, the life expectancy will increase by 0.0807905 (29.5 days) on average, while keep all other predicting variables constant. 

```{r}
0.0807905*365

```

*Reason 2*: Governments in countries with higher life expectancy value (>65) spent more on healthcare statistically than countries with lower life expectancy (<65). (Welchâ€˜s Two Sample t-test: t = -8.6583, df = 1821.2, p-value < 0.001). In short, government of longer lifespan countries spend more on healthcare.

Visualisation:

```{r}
# data frame
df2 <- life.data %>% 
  dplyr::select(Life.expectancy, Total.expenditure) %>% 
  mutate(my.group = ifelse(Life.expectancy >= 65, "LifeExp>65", "LifeExp<65")) %>% 
  group_by(my.group) %>% 
  mutate(count = n(),
         label = paste0(my.group, "\n(n=", count, ")"))

# plot
  ggplot(df2, aes(x = label, y = Total.expenditure, colour = my.group)) +
  geom_jitter(alpha = 0.5) +
  geom_boxplot(outlier.shape = NA, alpha = 0.1, colour = "black") +
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 5, color = "black") + 
  theme_classic()

```

Both of the distributions look normal (normal distribution) based on the distance between mean and median in the box plots as well as the overall shape of their boxplot. Technically, the boxes of both of the plot are symmetrical with mean and median located at the center. 

### Welch's T-test

Performing **Welch's T test** and the P-value of less than 0.05 concludes the difference between the both groups is statistically significant. Welch's T test is selected because the sample size different is quite large, and this test do not have the assumption of variance homogeneity between groups and therefore different sample size is allowed. 

```{r}
t.test(df2$Total.expenditure~df2$my.group)

```


## Q3. Infant and Adult Mortality versus Life Expectancy

**Question: How does Infant and Adult mortality rates affect life expectancy?**

Both infant and adult mortality have statistical negative impact on life expectancy. Based on the output of multiple linear regression in previous section:

* Any increment in one unit of adult mortality, life expectancy will be reduced by 0.0222 (P-value < 0.001)

* Any increment in one unit of infant deaths, life expectancy will be reduced by 0.0028 (P-value < 0.01)


```{r, fig.width=12, fig.height=10}

# df
df3 <- life.data %>% 
  dplyr::select(Status, Life.expectancy, Adult.Mortality, infant.deaths) %>% 
  pivot_longer(c(3:4), names_to = "myvar", values_to = "myval") %>% 
  mutate(myvar = as.factor(myvar))

# plot
ggplot(df3, aes(y = Life.expectancy, x = myval, color = myvar)) +
  geom_point(alpha = 0.5) +
  facet_wrap(~myvar, scales = "free_x") +
  theme_classic() +
  theme(legend.position = "none") +
  labs(x = "", y = "Life Expectancy") 

```

## Q4. Correlation of schooling, BMI, and alcohol with Life Expectancy

**Question: Does Life Expectancy has positive or negative correlation with schooling, BMI, drinking alcohol etc.**

Setting up dataframe for this section.

```{r}
df4 <- life.data %>% dplyr::select(Status, Life.expectancy, Alcohol, BMI, Schooling)

```

### Correlation

Correlation is a measure of association between variables **without making any assumption whether life expectancy is dependent on alcohol, BMI, and schooling**. 

Result shows that:

* Life expectancy has a week positive correlation with alcohol, r = 0.42     
* Life expectancy has a moderate positive correlation with BMI, r = 0.57     
* Life expectancy has a good positive correlation with schooling, r = 0.76     

```{r}
cor.data <- cor(df4[2:5])
corrplot(cor.data, method = "number", type = "lower")

```

### PCA

A PCA and various scatter plots are graphed to act as visual aid. 

**Main points**:

* PCA supports the correlation that "life expectancy" is more related to "BMI" and "Schooling", and less related to "Alcohol" consumption". If a variable is negatively correlated to life expectancy, it will be located at the opposite side of the origin. The PCA also explains excellently well the variation in the dataset at a combination of both dimension at 82.6%.

* PCA also help revealing that developed countries have higher degree in alcohol consumption, schooling, BMI, and life expectancy than many developing countries. 

* Three scatter plots at the bottom with an overall correlation line plotted (Not Based On Country Status) also supports the findings of correlations in previous correlation plot. 

```{r, fig.width=14, fig.height=16, warning=FALSE, message=FALSE}

res.pca <- PCA(df4, quali.sup = 1, graph = F)

f1 <- fviz_pca_biplot(res.pca, palette = "Set2", repel = T, habillage = "Status",
                addEllipses = T, geom.ind = "point", 
                pointsize = 1.5, pointshape = 21, col.var = "blue")
f2 <- fviz_screeplot(res.pca, addlabels = T, ylim = c(0, 70))
f3 <- fviz_contrib(res.pca, choice = "var")
f4 <- ggplot(df4, aes(y = Life.expectancy, x = Alcohol)) + geom_point(aes(color = Status), alpha = 0.5) + 
  geom_smooth(se = F, method = "lm") + theme_classic() + labs(title = "Alcohol")
f5 <- ggplot(df4, aes(y = Life.expectancy, x = BMI)) + geom_point(aes(color = Status), alpha = 0.5) + 
  geom_smooth(se = F, method = "lm") + theme_classic() + labs(title = "BMI")
f6 <- ggplot(df4, aes(y = Life.expectancy, x = Schooling)) + geom_point(aes(color = Status), alpha = 0.5) + 
  geom_smooth(se = F, method = "lm") + theme_classic() + labs(title = "Schooling")


right <- plot_grid(f2, f3, ncol = 1)
top <- plot_grid(f1, right, rel_widths = c(2.5, 1))
bottom <- plot_grid(f6, f5, f4, nrow = 1)

plot_grid(top, bottom, ncol = 1)


```

### Regression 

If attempt to describe the dependence of life expectancy on alcohol, BMI and schooling, a multiple linear regression model can be created. Output shows that the BMI and Schooling are statistically related to life expectancy. However, the model has higher residual standard error rate and explaining less variation in the life expectancy (lower adjusted R-squared of 60%). 

```{r}
model1 <- lm(Life.expectancy ~., data = df4[, 2:5])
summary(model1)

```

Compared to the output of following multiple linear regression model that built previously, this model has a lower level of residual standard error and adjusted R-squared. These indicates that it is a better model.

```{r}
summary(res.mlr2)

```

**Insights**:

Alcohol is insignificantly related to life expectancy at a P-value of 0.778, whereas BMI and schooling are significantly related to life expectancy at a P-value of lower than 0.01. Both BMI and schooling relates to life expectancy positively. One unit increase in BMI, the life expectancy is expected to increase 0.027 year on average, whereas one unit increase in schooling, life expectancy is expected to increase 1.15 year on average (Adjusted R-squared: 0.8538, F(15, 2775) = 1087, P < 0.01). 


## Q5. Population versus lower life expectancy?

**Question: Do densely populated countries tend to have lower life expectancy?**

Both parametric and non-parametric correlation methods ("pearson" and "spearman") suggest that the correlation between population and life expectancy is negative and the correlation is actually extremely small. 

Setting the dataset: 

```{r}
df5 <- life.data %>% dplyr::select(Status, Life.expectancy, Population) %>% 
  mutate(Population.log = log(Population),
         Life.expectancy.log = log(Life.expectancy))

```

Pearson correlation:

```{r}
cor(y = df5$Life.expectancy, x = df5$Population, method = "pearson")
```
More conservative non-parametric method: Spearman correlation: 

```{r}
cor(y = df5$Life.expectancy, x = df5$Population, method = "spearman")
```
A scatter plot has the same result, the relationship between population and life expectancy is quite difficult to see, and the situation is similar for both developing and developed countries. The R-squared values (explained variation) of two regression equations are very low.   

```{r, fig.height=6, fig.width=10, message=TRUE, warning=FALSE}

ggscatter(df5, x = "Population.log", y = "Life.expectancy", color = "Status", add = "reg.line") +
  stat_regline_equation(aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~~"), color = Status)) +
  labs(x = "log(Population)",
       title = "Life Expectancy versus Log-Population, Grouped by Country Status") +
  theme(plot.title = element_text(face = "bold", size = 15, hjust = 0.5))

```

From the plot, we can see that lower life expectancy is generally associated with developing countries, and life expectancy is generally higher in developed countries. Life expectancy is generally dictated by many variables, as specified in the multiple linear regression model I have built previously. Many factors are related and are required to understand the variability in the life expectancy. 

## Q6. Does developed countries have higher life expectancy?

Getting the data frame:

```{r}
df6 <- df5 %>% dplyr::select(Status, Life.expectancy) %>% 
  group_by(Status) %>% 
  mutate(count = n(),
         Country.Status = paste0(Status, " (n=", count, ")")) 

```

### Shapiro-Wilk test

The formal normality test is called Shapiro-Wilk test with a null hypothesis that the distribution is normal. The shapiro-wilk test rejects the null hypothesis of group and saying their data are not normally distribution.  

```{r}
by(data = df6$Life.expectancy, INDICES = df6$Country.Status, shapiro.test)

```

However, I will reject the result of Shapiro-Wilk test because the sample size are too large for this test to handle. In general, 

* if the sample size is too small, Shapiro-Wilk test will tend to conclude that the data is normally distributed (become harder to reject null hypothesis), and

* if the sample size is too large, Shapiro-Wilk test will tend to conclude that a set of data is not normally distributed (become easier to reject null hypothesis).

Therefore, visual aids for normality assessments are required:

```{r}
g1 <- ggplot(df6, aes(x = Life.expectancy, color = Status)) +
  geom_histogram(alpha = 0) +
  theme_bw() +
  facet_wrap(~Country.Status, scales = "free_x") +
  theme(legend.position = "none")


g2 <- ggplot(df6, aes(x = Life.expectancy, y = "", color = Status)) +
  geom_boxplot() +
  theme_bw() +
  facet_wrap(~Country.Status, scales = "free_x") +
  theme(legend.position = "none") +
  stat_summary(fun = "mean", geom = "point", shape = 4, size = 5, color = "black") 
  

plot_grid(g1, g2, ncol = 1)

```


To meet the requirement of normality assumption of t-test, the data doesn't have to be perfectly normal but it has to be at least roughly fits a bell curve shape. 

* From the histogram, I can see bell curve in two different degrees,   
* However, the boxplot of developed countries suggest normality (the box is symmetrical with the mean and median in the center) but the data distribution of developing countries is not normal. 

### Wilcoxon Signed Rank Test 

A non-parametric, median-based comparison test is run and concludes that the difference between life expectancy in developed and developing countries is statistically significance (Wilcoxon rank sum test: W = 1136054, p-value < 0.001).  

```{r}
wilcox.test(df6$Life.expectancy~df6$Country.Status, paired = F)

```


## Q7. What is the impact of Immunization coverage on life Expectancy?

Immunization coverage has positive correlation with life expectancy, as indicated by the immunisation of Hepatitis B, Polio, and Diphtheria at following correlation values. The correlations are moderate. 

```{r}
# set up data frame
df7 <- life.data %>% 
  dplyr::select(Life.expectancy, Hepatitis.B, Polio, Diphtheria)

corrplot(cor(df7), method = "number", type = "upper")

```

Visually: 

```{r, fig.height=8, fig.width=12, message=FALSE, warning=FALSE}
df7.2 <- df7 %>% 
  pivot_longer(c(2:4), names_to = "myvar", values_to = "myvalues") %>% 
  mutate(myvar = as.factor(myvar))

ggplot(df7.2, aes(y = Life.expectancy, x = myvalues, colour = myvar)) + 
  geom_point(alpha = 0.5) + 
  facet_wrap(~myvar) + geom_smooth(se = F, method = "lm") +
  theme_bw() +
  theme(legend.position = "none")
  

```

Statistics from the multiple linear regression model built previously suggests that:

* Diphtheria has a statistical positive relationship with life expectancy, at a P-value of less than 0.05. An increase in one % of Diphtheria tetanus toxoid and pertussis (DTP3) immunization coverage among 1-year-olds, life expectancy will increase by 0.03 year on average.

* Polio has also a statistical positive relationship with life expectancy, at a P-value of less than 0.05. An increase in one % of Polio immunisation among 1-year-olds, life expectancy will increase by 0.02 year on average.

* Hepatitis B immunisation do not have a statistical relationship with life expectancy, which means that having an increment in Hepatitis B immunisation can lead to zero increment in life expectancy.  



## Q8 Longiditudinal Multilevel Modeling with Years

**Question: How life expectancy has changed over the years in developed and developing countries? Please also find the impacts of "Status", "Total.expenditure", "Measles", "HIV.AIDS", "Schooling", "Diphtheria", "Hepatitis.B", and "Polio".**

The section is specially designed for if there is an interest in finding out the effect of years in relation to life expectancy. 

The associated predictors are:

```{r}
variables <- c("Status", "Total.expenditure", "Measles", "HIV.AIDS", "Schooling", "Diphtheria", "Hepatitis.B", "Polio")

variables %>% kbl(col.names = "Associated Predictors") %>% kable_styling(full_width = F, bootstrap_options = c("stripped", "bordered", "hover"))

```

### Time-transformation

There are following levels within the variable "year".

```{r}
levels(life.data$Year)
```

Transforming the "year" to numerical values starting with 0 for 2000, 1 for 2001, 2 for 2002 and all the way until 15 to 2015.
 
```{r}
life.data2 <- life.data %>% 
  mutate(Year = fct_recode(Year,
                            "0" = "2000", 
                            "1" = "2001", 
                            "2" = "2002", 
                            "3" = "2003", 
                            "4" = "2004", 
                            "5" = "2005", 
                            "6" = "2006", 
                            "7" = "2007", 
                            "8" = "2008", 
                            "9" = "2009", 
                            "10" = "2010", 
                            "11" = "2011", 
                            "12" = "2012", 
                            "13" = "2013", 
                            "14" = "2014", 
                            "15" = "2015")) %>%  
  mutate(Year = as.numeric(as.character(Year)))

```


**Set up data frame to be used for this section**

```{r}
df8 <- life.data2 %>% 
  dplyr::select(Country, Year, Status, Life.expectancy, Total.expenditure, Measles, HIV.AIDS, Schooling, Diphtheria, Hepatitis.B, Polio)

glimpse(df8)

```


### Multicollinearity Check

One of the assumption of linear mixed models is predictors are free from multicollinearity issues. I will be using correlation matrix for this assessment with correlation higher than 0.7 as a threshold that should not be exceeded (Anderson, Sweeney & Williams 2006). 

```{r, fig.width=8, fig.height=8}
df_cor <- df8 %>%
  dplyr::select_if(is.numeric) %>% 
  dplyr::select(-Life.expectancy) %>% 
  cor()

corrplot(df_cor, method = "number", type = "lower")

```

Removing "Diphtheria" from the dataset because its correlations with "Hepatitis.B" and "Polio" are 0.68 and 0.67, these values are very closed to 0.7 and therefore there might be a risk of multicollinearity. 

```{r}
df8 <- df8 %>% dplyr::select(-Diphtheria)

```


### Visualisation

The purposes of visualisation here are to see confirm visually that, 

* is there inherent difference between countries at time 0 (Year-2000) in both developed and developing status (different intercept) ?

* is the effect of year on life expectancy different between countries (different slope)?

**Graph 1**: 

```{r, fig.width=14, fig.height=6}
ggplot(df8, aes(x = Year, y = Life.expectancy, color = Country)) +
  geom_point() +
  geom_line() +
  facet_wrap(~Status) +
  theme_classic() +
  theme(legend.position = "none") +
  labs()

```
**Graph 2 (Alternative)**: 

```{r, fig.width=15, fig.height=30, warning=FALSE, message=FALSE}

ggplot(df8, aes(x = Year, y = Life.expectancy)) +
  geom_point() + 
  geom_line() +  
  facet_wrap(~Country, scale = "free_x") +
  theme_classic() +
  labs(title = "Life Expectancy of Countries from 2000 to 2015")

```

**Insights from graph 1 and graph 2**

* Life expectancy grows *linearly* with time  

* Different intercept and slope for each country status (Developed vs Developing)

* Differences between developed and developing countries can be strong  

* Within each country status, high individual variations between countries. For example, some developing countries have higher values for their life expectancy. 



### Unconditional Mean Model

**Model 1**

Following model 1 is built with only 2 variables - life expectancy as the responding variable (y) and countries as the random effect.

```{r}

model1 <- lme(Life.expectancy ~ 1, random =~ 1|Country, data = df8, method = "ML")

summary(model1)

```

Output of model 1 concludes that the intercept (69.36) is significantly differs from zero, which is the grand mean of life expectancy of all years.

There are 193 countries in the dataset. By putting countries as a random effect, model 1 assumes all countries have different intercept. 

The 95% confidence interval of the intercept is between 68.088 and 70,636, it is a range indicating where the true intercept may be located. The interval does not overlap with zero and therefore it is a significant interval.   

```{r}
intervals(model1)

```

### Unconditional Growth Model

**Model 2 - Year as fixed**

Model 2 starts having year as the predictor (fixed effect). This model considers that all countries have the same slope profile (although intercepts are different), which is highly unlikely but a statistical output can help to convince when compare model 2 to model 3.  

```{r}
model2 <- lme(Life.expectancy ~ Year, random =~ 1|Country, data = df8, method = "ML")
summary(model2)

```

In the output of model 2, the p-value of Year as a fixed effect is significant and indicates that "Year" has a significant relationship with life expectancy. In term of the beta coefficient estimate, 0.35 year of life expectancy is expected to increase in average for each unit increase of "Year".  

Based on simple ANOVA comparison, model 2 is a better model 1. Both models are statistically different (P-value < 0.001) and the improvement of AIC, BIC, logLik is significant. 

```{r}
anova(model1, model2)

```


**Model 3 - Year as fixed and random**

Model 3 considers "Year" as a fixed effect (significant) but also a random effect because each country is likely to have different slope of life expectancy across years between 2000 and 2015. 

Again, this section considers that the slope is different for different countries, and the intercept is different because of inherent difference among countries. 

```{r}
model3 <- lme(Life.expectancy ~ Year, random =~ Year|Country, 
              data = df8,
              method = "ML")

summary(model3)

```

**Important Insights**

* In random effect chunk of the output, there is a negative correlation (Corr = -0.69) which indicates that there is a negative correlation between intercept and slope. When a country intercept is *increased* by one unit, the slope of life expectancy across years of the country would decrease by *0.69* standard deviation. 

* Many developing countries have lower intercepts (lower life expectancy at year 2000) than developed countries, and therefore their slope of life expectancy improvement across the years would be experiencing a higher degree of gradient than develop countries.

Model 3 is better and statistically different from model 2 (p-value of less than 0.001) in terms of the improvements of AIC, BIC, and logLik. Model 3 is a better fit of the data than model 2.

```{r}
anova(model3, model2)

```


### Conditional Growth Model

**Model 4 - Year as fixed and random**

Model 4 is an improvement from model 3. This model will start adding in predictors as main effects (fixed effects) and interaction terms. 

```{r}
model4 <- lme(Life.expectancy ~ Status*Year + Status*Total.expenditure +
                Measles + HIV.AIDS + 
                Status*Schooling + Hepatitis.B + Polio, 
              random =~ Year|Country,
              data = df8, 
              method = "ML")
  
```

Model 4 is better statistically than model 3 (p-value < 0.0001) with following statistics.

```{r}
anova(model3, model4)
```

```{r}
summary(model4)

```


**Insights**

* Model 4 assumes different slope and intercepts (starting life expectancy in year-2000) for each country 

* Developing country status has a significant negative relationship with life expectancy (p-value < 0.01).

* Year has significant effect on life expectancy (p-value < 0.001). Output shows that life expectancy of human increases each year by 0.25 year on average. 

* HIV/AIDS deaths is significantly and negatively related to life expectancy at a p-value of < 0.001.

* Schooling is significantly related to life expectancy in a positve way at a p-value of 0.0442.

* There is no interaction effect of developing status with year, total expenditure, and schooling. 

Following are the 95% confidence level of bata coefficient estimate ("Value") from above output. Reading guide: A fixed term is considered insignificant if its confidence interval overlaps with zero. 

```{r}
intervals(model4)

```

**ICC**

Following show the intraclass Coefficient Coefficient. ICC is an indication of how much variation in the life expectancy is captured by the random effect (Countries), by looking at the adjusted ICC. 

*ICC of model 3*

```{r, warning=FALSE}
performance::icc(model3)
```

*ICC of model 4*

```{r}
performance::icc(model4)

```


There is 98% of clustering taking place when model has no predictors (model 3). After addition of predictors in the full model (model 4), ICC is now at 94.5%. Both of ICC values are still considered at a very high level, which indicates that there are still a high amount of unexplained clustering taking place. Therefore, the researcher who are interested in this research question should consider including more variables to capture the unexplained information. 


# Conclusion

**Question 1: What are the predicting variables actually affecting the life expectancy?**

Based on multiple linear regression analysis, the positively statistical correlated variables (p < 0.05) are schooling (Coeff. Est: 1.15), total expenditure by government on health (Coeff. Est: 0.08), BMI (0.03), GDP (Coeff. Est: 0.00004), and the immunisation of Diphtheria (Coeff. Est: 0.03) and Polio (Coeff. Est: 0.02). The negatively statistical correlated variables (p < 0.05) are developing country status (Coeff. Est: -1.12), HIV/AIDS Death rate (Coeff. Est: -0.51), Adult mortality rate (Coeff. Est: -0.02), and infant deaths (Coeff. Est: -0.002) (Adjusted R^2: 0.85, F(15, 2775) = 1087, p < 0.001). 

**Question 2: Should a country having a lower life expectancy value (<65) increase its healthcare expenditure in order to improve its average lifespan?**

Yes. 1% increase in the healthcare expenditure by government, the life expectancy will increase by 0.081 (29.5 days) on average, while keep all other predicting variables constant (p < 0.05). Governments in countries with higher life expectancy value (>65) spent more on healthcare statistically than countries with lower life expectancy (<65) (Welchâ€˜s Two Sample t-test: t = -8.6583, df = 1821.2, p < 0.001).

**Question 3: How does Infant and Adult mortality rates affect life expectancy?**

Output from multiple linear regression shows that any increment in one unit of adult mortality, life expectancy will be reduced by 0.0222 (p < 0.001), whereas any increment in one unit of infant deaths, life expectancy will be reduced by 0.0028 (p < 0.01).

**Question 4: Does Life Expectancy has positive or negative correlation with schooling, BMI, drinking alcohol etc.**

Life expectancy has a week positive correlation with alcohol (r = 0.42), moderate positive correlation with BMI (r = 0.57), and a good positive correlation with schooling (r = 0.76). Principle component analysis (PCA) supports the correlation outcomes that "life expectancy" is more related to BMI and schooling, and less related to alcohol consumption. 

Alcohol is insignificantly related to life expectancy at a p-value of 0.778, whereas BMI and schooling are significantly related to life expectancy at a p-value of lower than 0.01. Both BMI and schooling relates to life expectancy positively. One unit increase in BMI, the life expectancy is expected to increase 0.027 year on average, whereas one unit increase in schooling, life expectancy is expected to increase 1.15 year on average (Adjusted R-squared: 0.8538, F(15, 2775) = 1087, p < 0.01).

**Question 5: Do densely populated countries tend to have lower life expectancy?**

Non-parametric (spearman) and parametric (Pearson) correlation measurement methods suggest the correlation between population and life expectancy is negative but the correlation is extremely small. 


**Question 6. Does developed countries have higher life expectancy?**

Yes. A non-parametric, median-based comparison test was run and concluded that the difference between developed and developing countries in life expectancy is statistically significant (Wilcoxon rank sum test: W = 1136054, p-value < 0.001).

**Question 7. What is the impact of Immunization coverage on life Expectancy?**

* Diphtheria has a statistical positive relationship with life expectancy, at a p-value of less than 0.05. An increase in one % of Diphtheria tetanus toxoid and pertussis (DTP3) immunization coverage among 1-year-olds, life expectancy will increase by 0.03 year on average.

* Polio has also a statistical positive relationship with life expectancy, at a p-value of less than 0.05. An increase in one % of Polio immunisation among 1-year-olds, life expectancy will increase by 0.02 year on average.

* Hepatitis B immunisation do not have a statistical relationship with life expectancy, which means that having an increment in Hepatitis B immunisation can lead to zero increment in life expectancy.

**Question 8: How life expectancy has changed over the years in developed and developing countries? Please also find the impacts of "Status", "Total.expenditure", "Measles", "HIV.AIDS", "Schooling", "Diphtheria", "Hepatitis.B", and "Polio".**

A full model that considered the trends of life expectancy between 2000 to 2015 have inherent differences among countries with the effect of year was the best model based on p-value comparison, AIC, BIC, logLik and ICC statistics. Significantly correlated variables are only (p < 0.05) developing country status (Coeff. Est: -8.6), year (Coeff. Est: 0.25), HIV/AIDS death rate (Coeff. Est: -0.33), and schooling (Coeff. Est: 0.34). There is no interaction effect between development status and year (p = 0.823). 

The full model detected that if a country has lower initial life expectancy in year-2000, it would have a higher slope in life expectancy across the year between 2000 and 2015 (intercept-slope corr = -0.55). It implies improvement of life expectancy in developing countries since 2000 to 2015. The full model also concludes that life expectancy of human increases each year by 0.25 year on average, with a confidence level between 0.16 year and 0.34 year (p < 0.001). 


*Thank you for reading*

# ACKNOWLEDGEMENTS

The data used in this project was collected from WHO and United Nations website with the help of Deeksha Russell and Duan Wang (KUMARRAJARSHI 2018).

# REFERENCE

Anderson D.R., Sweeney D.J, Williams T.A., 2006, *Essentials of Statistics for Business & Economics*, South-Western, Division of Thomson Learning, United States of America

Bruce, Peter, and Andrew Bruce. 2017. Practical Statistics for Data Scientists. Oâ€™Reilly Media.

James, Gareth, Daniela Witten, Trevor Hastie, and Robert Tibshirani. 2014. An Introduction to Statistical Learning: With Applications in R . Springer Publishing Company, Incorporated.

Kassambara.A 2018, *Machine Learning Essentials: Practical Guide in R*, eBook.

Kassambara.A n.d., *COMPARING MULTIPLE MEANS IN R*, viewed 1 July 2022, https://www.datanovia.com/en/lessons/ancova-in-r/#two-way-ancova 

Kumarrajarshi 2018, "Life Expectancy (WHO)", viewed 23 June 2022, https://www.kaggle.com/datasets/kumarajarshi/life-expectancy-who 


